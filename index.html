<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Class Companion</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ical.js/1.4.0/ical.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            transition: background-image 0.5s ease-in-out;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .event-card, .sidebar-event-card, .week-event, .canvas-item-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out, opacity 0.3s ease-in-out, background-color 0.3s;
        }
        .event-card:hover, .sidebar-event-card:hover, .week-event:hover, .canvas-item-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
        }
        .fade-in { animation: fadeInAnimation 0.5s ease-in forwards; }
        .fade-out { animation: fadeOutAnimation 0.5s ease-out forwards; }
        @keyframes fadeInAnimation { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeOutAnimation { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(10px); } }

        .content-bg { background-color: rgba(255, 255, 255, 0.97); }
        .nav-link.active { border-bottom: 2px solid #4f46e5; color: #4f46e5; }
        .view-toggle-btn.active { background-color: #4f46e5; color: white; }

        #calendarDisplayWeek { overflow-x: auto; }
        .weekly-grid-container { position: relative; padding-top: 40px; }
        .weekly-grid { display: grid; grid-template-columns: 60px repeat(5, minmax(100px, 1fr)); grid-auto-rows: 60px; gap: 1px; background-color: #e5e7eb; border: 1px solid #e5e7eb; border-radius: 4px; }
        .grid-header { font-weight: 600; text-align: center; padding: 8px 4px; background-color: #eef2ff; font-size: 0.875rem; position: sticky; top: 0; z-index: 20; height: 40px; }
        .time-slot { font-size: 0.75rem; text-align: right; padding: 0 4px; color: #6b7280; background-color: #f9fafb; display: flex; align-items: center; justify-content: flex-end; border-top: 1px solid #e5e7eb; grid-column: 1 / 2; }
        .day-column-bg { background-color: #ffffff; border-top: 1px solid #e5e7eb; }
        .day-column-content { grid-column: span 1; grid-row: 1 / -1; position: relative; border-left: 1px solid #e5e7eb; background-color: transparent; }
        .day-column-content[data-day-index="0"] { grid-column: 2 / 3; } .day-column-content[data-day-index="1"] { grid-column: 3 / 4; } .day-column-content[data-day-index="2"] { grid-column: 4 / 5; } .day-column-content[data-day-index="3"] { grid-column: 5 / 6; } .day-column-content[data-day-index="4"] { grid-column: 6 / 7; }
        .week-event { position: absolute; left: 2px; right: 2px; font-size: 0.7rem; line-height: 1.2; padding: 2px 4px; border-radius: 4px; border: 1px solid rgba(0,0,0,0.1); overflow: hidden; cursor: default; box-shadow: 0 1px 3px rgba(0,0,0,0.05); z-index: 10; opacity: 1; transform: translateY(0); }
        .week-event.clickable-week-event { cursor: pointer; }
        .week-event.fade-in { animation: fadeInAnimation 0.5s ease-in forwards; }
        .week-event:hover { filter: brightness(1.1); }
        .week-event.canvas-assignment-event { border-left: 3px solid #e53e3e; background-color: #fed7d7 !important; }


        .mapping-item { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
        .mapping-item input[type="text"], .mapping-item input[type="color"], .mapping-item select { padding: 4px 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.875rem; }
        .mapping-item input[type="color"] { height: 34px; width: 40px; padding: 2px; cursor: pointer; }
        .mapping-item button { background: none; border: none; color: #ef4444; cursor: pointer; font-size: 1.2rem; }
        .mapping-item button:hover { color: #dc2626; }

        #sidebar { width: 250px; flex-shrink: 0; }
        .sidebar-event-card { background-color: #f3f4f6; border-left: 4px solid #6b7280; }
        .sidebar-event-card.canvas-assignment { border-left-color: #e53e3e; background-color: #fee2e2; }


        .status-indicator { display: flex; align-items: center; font-size: 0.8rem; margin-top: -1rem; margin-bottom: 1rem; }
        .status-icon { width: 10px; height: 10px; border-radius: 50%; margin-right: 6px; }
        .status-icon.live { background-color: #10b981; }
        .status-icon.failed svg { width: 12px; height: 12px; color: #f97316; }
        .status-text { color: #6b7280; }
        .status-text.failed { color: #f97316; font-weight: 500; }

        .canvas-item-card { background-color: #fff; border: 1px solid #e5e7eb; }
        .clickable-class-link { color: inherit; text-decoration: none; }
        .clickable-class-link:hover { text-decoration: underline; color: #3b82f6; }

        /* Notification Settings */
        .notification-preference { display: flex; align-items: center; margin-bottom: 0.5rem; }
        .notification-preference label { margin-right: 0.5rem; min-width: 150px; }
        .notification-preference input[type="checkbox"] { margin-right: 0.5rem; }
        .notification-preference input[type="number"] { width: 70px; padding: 0.25rem 0.5rem; }

        /* "NOW" and "In X mins" indicators */
        .time-indicator {
            font-size: 0.7rem;
            font-weight: 500;
            padding: 0.1rem 0.3rem;
            border-radius: 0.25rem;
            margin-left: 0.5rem;
        }
        .time-indicator-now {
            background-color: #facc15; /* yellow-400 */
            color: #713f12; /* yellow-800 */
        }
        .time-indicator-upcoming {
            background-color: #a7f3d0; /* green-200 */
            color: #047857; /* green-700 */
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <nav class="bg-white shadow-md sticky top-0 z-30">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <span class="text-xl font-bold text-indigo-600">Class Companion</span>
                </div>
                <div class="flex items-center space-x-4">
                    <button data-section="calendar" class="nav-link text-gray-600 hover:text-indigo-600 px-3 py-2 rounded-md text-sm font-medium transition duration-150 ease-in-out active">Calendar</button>
                    <button data-section="canvas" class="nav-link text-gray-600 hover:text-indigo-600 px-3 py-2 rounded-md text-sm font-medium transition duration-150 ease-in-out">Canvas</button>
                    <button data-section="settings" class="nav-link text-gray-600 hover:text-indigo-600 px-3 py-2 rounded-md text-sm font-medium transition duration-150 ease-in-out">Settings</button>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto p-4 md:p-8">

        <section id="settingsSection" class="content-bg rounded-lg shadow-lg p-6 md:p-8 mb-8 hidden fade-in">
            <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-6 border-b pb-2">Settings</h2>

            <div class="mb-8 pb-6 border-b">
                <h3 class="text-lg font-semibold text-gray-700 mb-3">Proxy & Compass Feed</h3>
                 <label for="workerUrl" class="block text-sm font-medium text-gray-700 mb-2">Cloudflare Worker URL:</label>
                <input type="url" id="workerUrl" placeholder="https://your-worker.your-name.workers.dev" class="block w-full px-3 py-2 mb-3 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">

                <label for="calendarUrl" class="block text-sm font-medium text-gray-700 mb-2">Compass Calendar Feed URL (.ics):</label>
                <div class="flex flex-col sm:flex-row gap-2">
                    <input type="url" id="calendarUrl" placeholder="https://your-school.compass.education/..." class="flex-grow block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    <button id="loadCalendarBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out whitespace-nowrap">
                        Save & Load Compass
                    </button>
                </div>
                 <p class="mt-2 text-xs text-gray-500">Your Worker URL and Compass URL are saved locally. Auto-refresh every 10 seconds is enabled.</p>
            </div>

            <div class="mb-8 pb-6 border-b">
                <h3 class="text-lg font-semibold text-gray-700 mb-3">Class Naming & Coloring (Compass)</h3>
                <p class="text-sm text-gray-600 mb-1">Define short codes found in your Compass class names.</p>
                <p class="text-sm text-gray-600 mb-4">If a code is found anywhere within a class name (e.g., 'ENG' in '09ENG1B01'), the <strong class="font-medium">entire original class name</strong> will be replaced with the "Full Name" you provide (e.g., 'English'). Assign colors for identification.</p>
                <div id="mappingsList" class="mb-4 space-y-2"></div>
                <div class="flex flex-col sm:flex-row gap-2">
                     <input type="text" id="newMappingCode" placeholder="Code (e.g., ENG)" class="px-3 py-2 border border-gray-300 rounded-md shadow-sm sm:text-sm">
                     <input type="text" id="newMappingName" placeholder="Full Name (e.g., English)" class="flex-grow px-3 py-2 border border-gray-300 rounded-md shadow-sm sm:text-sm">
                     <div class="flex items-center gap-2">
                        <select id="newMappingPastelColor" class="px-3 py-2 border border-gray-300 rounded-md shadow-sm sm:text-sm bg-white">
                            <option value="">-- Pastel --</option>
                        </select>
                        <span class="text-sm text-gray-500">or</span>
                        <input type="color" id="newMappingColor" value="#e5e7eb" class="h-auto p-1 border border-gray-300 rounded-md shadow-sm cursor-pointer">
                     </div>
                     <button id="addMappingBtn" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-md shadow-sm text-sm">Add</button>
                </div>
            </div>

            <div class="mb-8 pb-6 border-b">
                <h3 class="text-lg font-semibold text-gray-700 mb-3">Canvas Integration</h3>
                 <p class="text-sm text-gray-600 mb-2">Ensure your Cloudflare Worker URL is set above.</p>
                 <label for="canvasDomain" class="block text-sm font-medium text-gray-700 mb-2">Canvas Domain:</label>
                <input type="url" id="canvasDomain" placeholder="https://yourinstitution.instructure.com" class="block w-full px-3 py-2 mb-3 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                <label for="canvasToken" class="block text-sm font-medium text-gray-700 mb-2">Canvas API Access Token:</label>
                <input type="password" id="canvasToken" placeholder="Paste your token here" class="block w-full px-3 py-2 mb-3 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                <button id="saveCanvasSettingsBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-md shadow-sm text-sm">Save Canvas Settings & Fetch</button>
                <p class="mt-2 text-xs text-gray-500">Your Canvas domain and token are saved locally.</p>
            </div>

            <div class="mb-8 pb-6 border-b">
                <h3 class="text-lg font-semibold text-gray-700 mb-3">Compass Class to Canvas Course Mapping</h3>
                <p class="text-sm text-gray-600 mb-4">Link your Compass class names (after your custom naming above is applied) to your Canvas Course IDs. Get Course IDs from the URL of a Canvas course page (e.g., .../courses/COURSE_ID).</p>
                <div id="canvasCourseMappingsList" class="mb-4 space-y-2"></div>
                <div class="flex flex-col sm:flex-row gap-2">
                     <input type="text" id="compassClassNameForCanvas" placeholder="Compass Class Name" class="flex-grow px-3 py-2 border border-gray-300 rounded-md shadow-sm sm:text-sm mb-2 sm:mb-0">
                     <input type="text" id="canvasCourseIdForMapping" placeholder="Canvas Course ID" class="flex-grow px-3 py-2 border border-gray-300 rounded-md shadow-sm sm:text-sm">
                     <button id="addCanvasCourseMappingBtn" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-md shadow-sm text-sm">Add Mapping</button>
                </div>
            </div>

            <div class="mb-8 pb-6 border-b">
                <h3 class="text-lg font-semibold text-gray-700 mb-3">Notifications</h3>
                <div id="notificationPermissionStatus" class="text-sm text-gray-600 mb-3"></div>
                <div class="space-y-3">
                    <div class="notification-preference">
                        <input type="checkbox" id="notifyClassesEnabled">
                        <label for="notifyClassesEnabled" class="font-medium text-gray-700">Class Reminders:</label>
                        <input type="number" id="notifyClassesLeadTime" min="1" class="border-gray-300 rounded-md shadow-sm">
                        <span class="ml-2 text-sm text-gray-500">minutes before</span>
                    </div>
                    <div class="notification-preference">
                        <input type="checkbox" id="notifyAssignmentsEnabled1">
                        <label for="notifyAssignmentsEnabled1" class="font-medium text-gray-700">Assignment Reminder 1:</label>
                        <input type="number" id="notifyAssignmentsLeadTime1" min="1" class="border-gray-300 rounded-md shadow-sm">
                        <span class="ml-2 text-sm text-gray-500">minutes before due</span>
                    </div>
                     <div class="notification-preference">
                        <input type="checkbox" id="notifyAssignmentsEnabled2">
                        <label for="notifyAssignmentsEnabled2" class="font-medium text-gray-700">Assignment Reminder 2:</label>
                        <input type="number" id="notifyAssignmentsLeadTime2" min="1" class="border-gray-300 rounded-md shadow-sm">
                        <span class="ml-2 text-sm text-gray-500">minutes before due</span>
                    </div>
                     <div class="notification-preference">
                        <input type="checkbox" id="notifyTimetableChangesEnabled">
                        <label for="notifyTimetableChangesEnabled" class="font-medium text-gray-700">Timetable Changes:</label>
                        <span class="ml-2 text-sm text-gray-500">(Room, Time, Cancellation)</span>
                    </div>
                </div>
                <button id="saveNotificationSettingsBtn" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md shadow-sm text-sm">Save Notification Preferences</button>
            </div>


             <div class="mb-8">
                <h3 class="text-lg font-semibold text-gray-700 mb-3">Appearance</h3>
                <label for="backgroundUrl" class="block text-sm font-medium text-gray-700 mb-2">Custom Background Image URL:</label>
                <div class="flex flex-col sm:flex-row gap-2">
                    <input type="url" id="backgroundUrl" placeholder="Enter image URL..." class="flex-grow block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    <button id="saveBackgroundBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out whitespace-nowrap">Save BG</button>
                     <button id="resetBackgroundBtn" class="bg-gray-400 hover:bg-gray-500 text-white font-semibold py-2 px-4 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 transition duration-150 ease-in-out whitespace-nowrap">Reset BG</button>
                </div>
                 <p class="mt-2 text-xs text-gray-500">Leave blank to use the default background.</p>
            </div>

             <div id="settingsMessageArea" class="text-center my-4"></div>
        </section>

        <section id="calendarSection" class="hidden fade-in">
             <div class="flex flex-col lg:flex-row gap-6">
                 <div class="flex-grow content-bg rounded-lg shadow-lg p-6 md:p-8 overflow-hidden">
                     <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-2 gap-4">
                         <h2 class="text-xl md:text-2xl font-bold text-gray-800 whitespace-nowrap">Your Schedule</h2>
                         <div class="flex items-center gap-2 border border-gray-300 rounded-md p-0.5 bg-gray-100">
                             <button id="listViewBtn" data-view="list" class="view-toggle-btn px-3 py-1 rounded-md text-sm font-medium transition duration-150 ease-in-out active">List</button>
                             <button id="weekViewBtn" data-view="week" class="view-toggle-btn px-3 py-1 rounded-md text-sm font-medium transition duration-150 ease-in-out">Week</button>
                         </div>
                     </div>
                     <div id="statusIndicator" class="status-indicator mb-6">
                         <span id="statusIcon" class="status-icon"></span>
                         <span id="statusText" class="status-text"></span>
                     </div>
                     <div id="listControls" class="flex flex-col md:flex-row gap-4 mb-6">
                         <div class="flex-grow">
                             <label for="searchBox" class="sr-only">Search Events</label>
                             <input type="search" id="searchBox" placeholder="Search events (class, room, teacher)..." class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                         </div>
                         <div>
                             <label for="sortOrder" class="sr-only">Sort Events By</label>
                             <select id="sortOrder" class="block w-full md:w-auto px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                 <option value="time">Sort by Time</option>
                                 <option value="name">Sort by Class Name</option>
                                 <option value="location">Sort by Location</option>
                             </select>
                         </div>
                     </div>
                     <div id="calendarMessageArea" class="text-center my-4"></div>
                     <div id="calendarDisplayList" class="space-y-4"></div>
                      <div id="calendarDisplayWeek" class="hidden">
                         <div class="weekly-grid-container">
                             <div class="grid grid-cols-[60px_repeat(5,minmax(100px,1fr))] gap-1 sticky top-0 z-20">
                                <div class="grid-header">Time</div> <div class="grid-header">Mon</div> <div class="grid-header">Tue</div> <div class="grid-header">Wed</div> <div class="grid-header">Thu</div> <div class="grid-header">Fri</div>
                             </div>
                             <div id="weeklyViewGrid" class="weekly-grid"></div>
                         </div>
                     </div>
                 </div>
                 <aside id="sidebar" class="content-bg rounded-lg shadow-lg p-4 lg:sticky lg:top-24 lg:self-start">
                     <h3 class="text-lg font-semibold text-gray-700 mb-4 border-b pb-2">Other Events & Due Dates</h3>
                     <div id="sidebarEvents" class="space-y-3 max-h-[70vh] overflow-y-auto"></div>
                 </aside>
             </div>
        </section>

        <section id="canvasSection" class="hidden fade-in">
            <div class="content-bg rounded-lg shadow-lg p-6 md:p-8">
                <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-6">Canvas Details</h2>
                <div id="canvasDataMessageArea" class="text-center my-4"></div>
                <div id="canvasCoursesDisplay" class="space-y-6">
                    </div>
            </div>
        </section>

    </main>

    <script>
        // --- Constants & DOM Elements ---
        const CALENDAR_URL_KEY = 'compassCalendarUrl';
        const WORKER_URL_KEY = 'compassWorkerUrl';
        const CLASS_MAPPINGS_KEY = 'compassClassMappings';
        const CLASS_COLORS_KEY = 'compassClassColors';
        const BACKGROUND_URL_KEY = 'compassBackgroundUrl';
        const CANVAS_DOMAIN_KEY = 'canvasDomain';
        const CANVAS_TOKEN_KEY = 'canvasToken';
        const CANVAS_COURSE_MAPPINGS_KEY = 'canvasCourseMappings';
        const NOTIFICATION_SETTINGS_KEY = 'classCompanionNotificationSettings';

        const DEFAULT_WORKER_URL = 'https://class-companion.thebestmate100.workers.dev';
        const DEFAULT_BACKGROUND_URL = 'https://external-content.duckduckgo.com/iu/?u=https%3A%2F%2Fwww.motionbolt.com%2Fwp-content%2Fuploads%2F2021%2F12%2FBackground_2.jpg&f=1&nofb=1&ipt=fb1e82a0f77bb090f3f284f3dee0d6b334a89a1437206a52786427eff0f2c650';
        const REFRESH_INTERVAL = 10000;
        const STATUS_UPDATE_INTERVAL = 1000;
        const NOTIFICATION_CHECK_INTERVAL = 30000;

        const PASTEL_COLORS = [
            { name: 'Mint', value: '#a2d2ff' }, { name: 'Lavender', value: '#bde0fe' },
            { name: 'Peach', value: '#ffafcc' }, { name: 'Sky Blue', value: '#cdb4db' },
            { name: 'Baby Pink', value: '#ffc8dd' }, { name: 'Periwinkle', value: '#a0c4ff' },
            { name: 'Light Yellow', value: '#fff1a0' }, { name: 'Seafoam', value: '#99d98c' },
            { name: 'Coral', value: '#ffb3a7' }, { name: 'Lilac', value: '#dcb0ff' }
        ];


        const workerUrlInput = document.getElementById('workerUrl');
        const urlInput = document.getElementById('calendarUrl');
        const loadButton = document.getElementById('loadCalendarBtn');
        const calendarDisplayList = document.getElementById('calendarDisplayList');
        const calendarDisplayWeek = document.getElementById('calendarDisplayWeek');
        const weeklyViewGrid = document.getElementById('weeklyViewGrid');
        const calendarMessageArea = document.getElementById('calendarMessageArea');

        const settingsMessageArea = document.getElementById('settingsMessageArea');
        const searchBox = document.getElementById('searchBox');
        const sortOrderSelect = document.getElementById('sortOrder');
        const navLinks = document.querySelectorAll('.nav-link');
        const settingsSection = document.getElementById('settingsSection');
        const calendarSection = document.getElementById('calendarSection');
        const canvasSection = document.getElementById('canvasSection');
        const listControls = document.getElementById('listControls');
        const listViewBtn = document.getElementById('listViewBtn');
        const weekViewBtn = document.getElementById('weekViewBtn');
        const mappingsListDiv = document.getElementById('mappingsList');
        const addMappingBtn = document.getElementById('addMappingBtn');
        const newMappingCodeInput = document.getElementById('newMappingCode');
        const newMappingNameInput = document.getElementById('newMappingName');
        const newMappingColorInput = document.getElementById('newMappingColor');
        const newMappingPastelColorSelect = document.getElementById('newMappingPastelColor');

        const sidebarEventsDiv = document.getElementById('sidebarEvents');
        const sidebar = document.getElementById('sidebar');
        const backgroundUrlInput = document.getElementById('backgroundUrl');
        const saveBackgroundBtn = document.getElementById('saveBackgroundBtn');
        const resetBackgroundBtn = document.getElementById('resetBackgroundBtn');
        const statusIndicatorDiv = document.getElementById('statusIndicator');
        const statusIconSpan = document.getElementById('statusIcon');
        const statusTextSpan = document.getElementById('statusText');

        const canvasDomainInput = document.getElementById('canvasDomain');
        const canvasTokenInput = document.getElementById('canvasToken');
        const saveCanvasSettingsBtn = document.getElementById('saveCanvasSettingsBtn');
        const canvasDataMessageArea = document.getElementById('canvasDataMessageArea');
        const canvasCoursesDisplay = document.getElementById('canvasCoursesDisplay');
        const canvasCourseMappingsListDiv = document.getElementById('canvasCourseMappingsList');
        const compassClassNameForCanvasInput = document.getElementById('compassClassNameForCanvas');
        const canvasCourseIdForMappingInput = document.getElementById('canvasCourseIdForMapping');
        const addCanvasCourseMappingBtn = document.getElementById('addCanvasCourseMappingBtn');

        const notificationPermissionStatusDiv = document.getElementById('notificationPermissionStatus');
        const notifyClassesEnabledCheckbox = document.getElementById('notifyClassesEnabled');
        const notifyClassesLeadTimeInput = document.getElementById('notifyClassesLeadTime');
        const notifyAssignmentsEnabled1Checkbox = document.getElementById('notifyAssignmentsEnabled1');
        const notifyAssignmentsLeadTime1Input = document.getElementById('notifyAssignmentsLeadTime1');
        const notifyAssignmentsEnabled2Checkbox = document.getElementById('notifyAssignmentsEnabled2');
        const notifyAssignmentsLeadTime2Input = document.getElementById('notifyAssignmentsLeadTime2');
        const notifyTimetableChangesEnabledCheckbox = document.getElementById('notifyTimetableChangesEnabled'); // New
        const saveNotificationSettingsBtn = document.getElementById('saveNotificationSettingsBtn');


        let compassWorkerUrl = DEFAULT_WORKER_URL;
        let allParsedEvents = [];
        let previousProcessedClassEvents = [];
        let processedClassEvents = [];
        let processedSidebarEvents = [];
        let currentSortOrder = 'time';
        let currentSearchTerm = '';
        let currentViewMode = 'list';
        let classMappings = {};
        let classColors = {};
        let backgroundUrl = DEFAULT_BACKGROUND_URL;
        let canvasDomain = '';
        let canvasToken = '';
        let canvasCourseMappings = {};
        let fetchedCanvasCourses = [];
        let notificationSettings = {
            classesEnabled: false, classesLeadTime: 5,
            assignmentsEnabled1: false, assignmentsLeadTime1: 60,
            assignmentsEnabled2: false, assignmentsLeadTime2: 5,
            timetableChangesEnabled: false // New
        };
        let notificationPermission = Notification.permission;
        let sentNotifications = new Set();
        let notificationCheckIntervalId = null;

        let messageTimeout = null;
        let refreshIntervalId = null;
        let statusUpdateIntervalId = null;
        let isFirstLoad = true;
        let isAutoRefreshing = false;
        let lastSuccessfulUpdateTime = null;
        let currentStatus = 'idle';

        const ICONS = { /* ... same as before ... */
             clock: `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 inline-block text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`,
             location: `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 inline-block text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>`,
             teacher: `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 inline-block text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>`,
             event: `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 inline-block text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>`,
             assignment: `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 inline-block text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>`,
             cloudError: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" /></svg>`,
             link: `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block ml-1 text-blue-500 hover:text-blue-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /></svg>`
        };

        loadButton.addEventListener('click', handleSaveAndLoad);
        searchBox.addEventListener('input', handleSearch);
        sortOrderSelect.addEventListener('change', handleSort);
        navLinks.forEach(link => link.addEventListener('click', handleNavClick));
        listViewBtn.addEventListener('click', () => switchViewMode('list'));
        weekViewBtn.addEventListener('click', () => switchViewMode('week'));
        addMappingBtn.addEventListener('click', handleAddMapping);
        mappingsListDiv.addEventListener('click', handleMappingListClick);
        saveBackgroundBtn.addEventListener('click', handleSaveBackground);
        resetBackgroundBtn.addEventListener('click', handleResetBackground);
        saveCanvasSettingsBtn.addEventListener('click', handleSaveCanvasSettings);
        addCanvasCourseMappingBtn.addEventListener('click', handleAddCanvasCourseMapping);
        canvasCourseMappingsListDiv.addEventListener('click', handleCanvasMappingListClick);
        newMappingPastelColorSelect.addEventListener('change', () => { if (newMappingPastelColorSelect.value) { newMappingColorInput.value = newMappingPastelColorSelect.value; }});
        saveNotificationSettingsBtn.addEventListener('click', handleSaveNotificationSettings);
        document.addEventListener('DOMContentLoaded', initializeApp);

        function initializeApp() {
            populatePastelColorOptions();
            loadSettings();
            applyBackground();
            renderMappingsList();
            renderCanvasCourseMappingsList();
            renderNotificationSettings();
            initializeStatusIndicator();
            setupNotificationPermission();
            startNotificationChecker();

            const savedCompassUrl = localStorage.getItem(CALENDAR_URL_KEY);
            if (compassWorkerUrl && savedCompassUrl) { urlInput.value = savedCompassUrl; startAutoRefresh(savedCompassUrl);
            } else if (!compassWorkerUrl) { showMessage('Please set your Cloudflare Worker URL in Settings.', 'error', 'settings'); updateStatusIndicator('idle');
            } else if (!savedCompassUrl) { showMessage('Go to Settings to enter your Compass calendar URL.', 'info', 'calendar'); updateStatusIndicator('idle'); }
            switchSection('calendar'); switchViewMode(currentViewMode);
        }

        function populatePastelColorOptions() { PASTEL_COLORS.forEach(color => { const option = document.createElement('option'); option.value = color.value; option.textContent = color.name; option.style.backgroundColor = color.value; newMappingPastelColorSelect.appendChild(option); }); }

        function loadSettings() {
             compassWorkerUrl = localStorage.getItem(WORKER_URL_KEY) || DEFAULT_WORKER_URL;
             workerUrlInput.value = compassWorkerUrl;
             classMappings = JSON.parse(localStorage.getItem(CLASS_MAPPINGS_KEY) || '{}');
             classColors = JSON.parse(localStorage.getItem(CLASS_COLORS_KEY) || '{}');
             backgroundUrl = localStorage.getItem(BACKGROUND_URL_KEY) || DEFAULT_BACKGROUND_URL;
             backgroundUrlInput.value = localStorage.getItem(BACKGROUND_URL_KEY) || '';
             canvasDomain = localStorage.getItem(CANVAS_DOMAIN_KEY) || '';
             canvasToken = localStorage.getItem(CANVAS_TOKEN_KEY) || '';
             canvasCourseMappings = JSON.parse(localStorage.getItem(CANVAS_COURSE_MAPPINGS_KEY) || '{}');
             canvasDomainInput.value = canvasDomain;
             canvasTokenInput.value = canvasToken;
             const savedNotificationSettings = JSON.parse(localStorage.getItem(NOTIFICATION_SETTINGS_KEY));
             if (savedNotificationSettings) {
                notificationSettings = { ...notificationSettings, ...savedNotificationSettings };
             }
        }

        function saveSettings(showMsg = true, type = 'general') {
            localStorage.setItem(WORKER_URL_KEY, workerUrlInput.value.trim());
            localStorage.setItem(CALENDAR_URL_KEY, urlInput.value.trim());
            localStorage.setItem(CLASS_MAPPINGS_KEY, JSON.stringify(classMappings));
            localStorage.setItem(CLASS_COLORS_KEY, JSON.stringify(classColors));
            localStorage.setItem(BACKGROUND_URL_KEY, backgroundUrlInput.value.trim());
            localStorage.setItem(CANVAS_DOMAIN_KEY, canvasDomainInput.value.trim());
            localStorage.setItem(CANVAS_TOKEN_KEY, canvasTokenInput.value.trim());
            localStorage.setItem(CANVAS_COURSE_MAPPINGS_KEY, JSON.stringify(canvasCourseMappings));
            localStorage.setItem(NOTIFICATION_SETTINGS_KEY, JSON.stringify(notificationSettings));

            loadSettings();
            applyBackground();

            if (showMsg) showMessage('Settings saved.', 'success', 'settings');

            if (type === 'general' && allParsedEvents.length > 0) {
                previousProcessedClassEvents = [...processedClassEvents];
                processAndClassifyEvents(allParsedEvents);
                isAutoRefreshing = false;
                renderViews();
            } else if (type === 'canvasAuth' || type === 'canvasMap') {
                if (compassWorkerUrl && canvasDomain && canvasToken) {
                    fetchCanvasData();
                }
            } else if (type === 'compass') {
                const currentCompassUrl = urlInput.value.trim();
                if (compassWorkerUrl && currentCompassUrl) {
                    isFirstLoad = true;
                    startAutoRefresh(currentCompassUrl);
                }
            } else if (type === 'notifications') {
                if (notificationSettings.classesEnabled || notificationSettings.assignmentsEnabled1 || notificationSettings.assignmentsEnabled2 || notificationSettings.timetableChangesEnabled) {
                    requestNotificationPermission();
                }
            }
        }
        function applyBackground() { document.body.style.backgroundImage = `url('${backgroundUrl || DEFAULT_BACKGROUND_URL}')`; }
        function handleSaveBackground() { const newUrl = backgroundUrlInput.value.trim(); localStorage.setItem(BACKGROUND_URL_KEY, newUrl); backgroundUrl = newUrl || DEFAULT_BACKGROUND_URL; applyBackground(); showMessage('Background saved.', 'success', 'settings'); }
        function handleResetBackground() { backgroundUrlInput.value = ''; localStorage.removeItem(BACKGROUND_URL_KEY); backgroundUrl = DEFAULT_BACKGROUND_URL; applyBackground(); showMessage('Background reset to default.', 'success', 'settings'); }
        function handleSaveCanvasSettings() {
            saveSettings(true, 'canvasAuth');
            if (compassWorkerUrl && canvasDomainInput.value.trim() && canvasTokenInput.value.trim()) {
                 fetchCanvasData();
            } else {
                showMessage('Worker URL, Canvas Domain and Token are required to fetch data.', 'error', 'settings');
            }
         }

        function renderMappingsList() {
            mappingsListDiv.innerHTML = ''; const sortedCodes = Object.keys(classMappings).sort();
            sortedCodes.forEach(code => { const name = classMappings[code]; const color = classColors[name] || '#e5e7eb'; const item = document.createElement('div'); item.className = 'mapping-item p-2 border rounded-md bg-gray-50';
                item.innerHTML = `<input type="text" value="${code}" data-code="${code}" class="mapping-code bg-gray-200 w-20" readonly><span>&rarr;</span><input type="text" value="${name}" data-code="${code}" class="mapping-name flex-grow"><input type="color" value="${color}" data-code="${code}" data-name="${name}" class="mapping-color"><button data-action="remove" data-code="${code}" title="Remove Mapping">&times;</button>`;
                mappingsListDiv.appendChild(item); });
            mappingsListDiv.querySelectorAll('.mapping-name, .mapping-color').forEach(input => input.addEventListener('change', handleMappingEdit));
        }
        function handleAddMapping() {
            const code = newMappingCodeInput.value.trim().toUpperCase();
            const name = newMappingNameInput.value.trim();
            let color = newMappingColorInput.value;
            if (newMappingPastelColorSelect.value) { color = newMappingPastelColorSelect.value; }
            if (!code || !name) { showMessage('Both Code and Full Name are required.', 'error', 'settings'); return; }
            if (classMappings[code]) { showMessage(`Code "${code}" already exists.`, 'error', 'settings'); return; }
            classMappings[code] = name; classColors[name] = color;
            newMappingCodeInput.value = ''; newMappingNameInput.value = ''; newMappingColorInput.value = '#e5e7eb'; newMappingPastelColorSelect.value = '';
            renderMappingsList(); saveSettings(true, 'general');
        }
        function handleMappingListClick(event) { const target = event.target; const action = target.getAttribute('data-action'); const code = target.getAttribute('data-code'); if (action === 'remove' && code) { const name = classMappings[code]; delete classMappings[code]; delete classColors[name]; renderMappingsList(); saveSettings(true, 'general'); } }
        function handleMappingEdit(event) { const input = event.target; const code = input.getAttribute('data-code'); const originalName = classMappings[code]; if (input.classList.contains('mapping-name')) { const newName = input.value.trim(); if (newName && newName !== originalName) { classMappings[code] = newName; if (classColors[originalName]) { classColors[newName] = classColors[originalName]; delete classColors[originalName]; } const colorInput = input.closest('.mapping-item').querySelector('.mapping-color'); if(colorInput) colorInput.setAttribute('data-name', newName); renderMappingsList(); saveSettings(true, 'general'); } else { input.value = originalName; } } else if (input.classList.contains('mapping-color')) { const name = input.getAttribute('data-name'); const newColor = input.value; if (name) { classColors[name] = newColor; saveSettings(true, 'general'); } } }
        function renderCanvasCourseMappingsList() {
            canvasCourseMappingsListDiv.innerHTML = ''; const sortedCompassNames = Object.keys(canvasCourseMappings).sort();
            sortedCompassNames.forEach(compassName => { const canvasId = canvasCourseMappings[compassName]; const item = document.createElement('div'); item.className = 'mapping-item p-2 border rounded-md bg-gray-50';
                item.innerHTML = `<input type="text" value="${compassName}" data-compass-name="${compassName}" class="canvas-map-compass-name bg-gray-200 flex-grow" readonly><span>&rarr;</span><input type="text" value="${canvasId}" data-compass-name="${compassName}" class="canvas-map-id w-32"><button data-action="remove-canvas-map" data-compass-name="${compassName}" title="Remove Mapping">&times;</button>`;
                canvasCourseMappingsListDiv.appendChild(item); });
            canvasCourseMappingsListDiv.querySelectorAll('.canvas-map-id').forEach(input => input.addEventListener('change', handleCanvasMappingEdit));
        }
        function handleAddCanvasCourseMapping() { const compassName = compassClassNameForCanvasInput.value.trim(); const canvasId = canvasCourseIdForMappingInput.value.trim(); if (!compassName || !canvasId) { showMessage('Compass Class Name and Canvas Course ID are required.', 'error', 'settings'); return; } if (canvasCourseMappings[compassName]) { showMessage(`Mapping for "${compassName}" already exists.`, 'error', 'settings'); return; } canvasCourseMappings[compassName] = canvasId; compassClassNameForCanvasInput.value = ''; canvasCourseIdForMappingInput.value = ''; renderCanvasCourseMappingsList(); saveSettings(true, 'canvasMap'); }
        function handleCanvasMappingListClick(event) { const target = event.target; const action = target.getAttribute('data-action'); const compassName = target.getAttribute('data-compass-name'); if (action === 'remove-canvas-map' && compassName) { delete canvasCourseMappings[compassName]; renderCanvasCourseMappingsList(); saveSettings(true, 'canvasMap'); } }
        function handleCanvasMappingEdit(event) { const input = event.target; const compassName = input.getAttribute('data-compass-name'); const newCanvasId = input.value.trim(); if (compassName && newCanvasId) { canvasCourseMappings[compassName] = newCanvasId; saveSettings(true, 'canvasMap'); } else if (compassName && !newCanvasId) { delete canvasCourseMappings[compassName]; renderCanvasCourseMappingsList(); saveSettings(true, 'canvasMap'); } }

        function handleNavClick(event) { const section = event.target.getAttribute('data-section'); switchSection(section); }
        function switchSection(section) {
            isAutoRefreshing = false; settingsSection.classList.add('hidden'); calendarSection.classList.add('hidden'); canvasSection.classList.add('hidden'); navLinks.forEach(link => link.classList.remove('active'));
            let activeNavLink = document.querySelector(`.nav-link[data-section="${section}"]`);
            if (activeNavLink) activeNavLink.classList.add('active');

            if (section === 'settings') { settingsSection.classList.remove('hidden');
            } else if (section === 'canvas') {
                canvasSection.classList.remove('hidden');
                if (compassWorkerUrl && canvasDomain && canvasToken) { fetchCanvasData(); }
                else { showMessageForCanvas('Please set Worker URL, Canvas Domain, and API Token in Settings.', 'info'); }
            } else {
                calendarSection.classList.remove('hidden');
                if (allParsedEvents.length > 0) { renderViews(); }
                else { const savedUrl = localStorage.getItem(CALENDAR_URL_KEY); if (!savedUrl && !compassWorkerUrl) showMessage('Go to Settings to enter Worker & Compass URLs.', 'info', 'calendar'); }
            }
        }
        function switchViewMode(mode) { currentViewMode = mode; listViewBtn.classList.toggle('active', mode === 'list'); weekViewBtn.classList.toggle('active', mode === 'week'); calendarDisplayList.classList.toggle('hidden', mode !== 'list'); calendarDisplayWeek.classList.toggle('hidden', mode !== 'week'); listControls.classList.toggle('hidden', mode !== 'list'); isAutoRefreshing = false; renderViews(); }

        function handleSaveAndLoad() {
            const workerURLValue = workerUrlInput.value.trim();
            const compassURLValue = urlInput.value.trim();
            if (!workerURLValue) { showMessage('Cloudflare Worker URL is required.', 'error', 'settings'); return; }
            if (!compassURLValue) { showMessage('Compass Calendar Feed URL is required.', 'error', 'settings'); return; }
            try { new URL(workerURLValue); new URL(compassURLValue); }
            catch (_) { showMessage('Invalid URL format for Worker or Compass URL.', 'error', 'settings'); return; }
            saveSettings(false, 'compass');
            showMessage('Settings saved. Starting auto-refresh...', 'loading', 'settings');
        }
        function startAutoRefresh(compassCalUrl) {
            stopAutoRefresh();
            if (!compassWorkerUrl) { showMessage('Worker URL not set. Cannot start auto-refresh.', 'error', 'calendar'); updateStatusIndicator('failed'); return; }
            fetchAndProcessCalendar(compassCalUrl, true);
            refreshIntervalId = setInterval(() => fetchAndProcessCalendar(compassCalUrl, false), REFRESH_INTERVAL);
            initializeStatusIndicator();
        }
        function stopAutoRefresh() { if (refreshIntervalId) clearInterval(refreshIntervalId); if (statusUpdateIntervalId) clearInterval(statusUpdateIntervalId); refreshIntervalId = null; statusUpdateIntervalId = null; }

        async function fetchAndProcessCalendar(compassCalUrl, isInitialLoadForThisCall = false) {
            if (!compassCalUrl || !compassWorkerUrl) { console.warn("Compass or Worker URL missing, skipping fetch."); return; }
            isAutoRefreshing = !isInitialLoadForThisCall;
            if (isFirstLoad && isInitialLoadForThisCall) { showMessage('Loading calendar data...', 'loading', 'calendar'); updateStatusIndicator('loading'); }
            try {
                const fetchUrl = `${compassWorkerUrl}/compass?url=${encodeURIComponent(compassCalUrl)}`;
                const response = await fetch(fetchUrl);
                if (!response.ok) { const errorData = await response.json().catch(() => ({ error: `HTTP error ${response.status}` })); throw new Error(errorData.error || `Failed to fetch from worker: ${response.status} ${response.statusText}`); }
                const icsData = await response.text(); if (!icsData) throw new Error('Fetched data from worker is empty.');
                const newParsedCompassEvents = parseCalendarData(icsData);

                if (isFirstLoad && isInitialLoadForThisCall) {
                    showMessage(`Successfully loaded ${newParsedCompassEvents.length} Compass events.`, 'success', 'calendar');
                    isFirstLoad = false;
                }
                lastSuccessfulUpdateTime = Date.now(); updateStatusIndicator('live');

                // Detect timetable changes for notifications
                if (!isInitialLoadForThisCall && notificationSettings.timetableChangesEnabled) {
                    detectAndNotifyTimetableChanges(newParsedCompassEvents, previousProcessedClassEvents);
                }

                previousProcessedClassEvents = [...processedClassEvents]; // Store Compass classes before merging with Canvas
                allParsedEvents = newParsedCompassEvents; // Start with fresh Compass events

                if (compassWorkerUrl && canvasDomain && canvasToken) {
                    await processCanvasAssignmentsIntoEvents(); // This will modify allParsedEvents
                }
                processAndClassifyEvents(allParsedEvents);
                renderViews();
            } catch (error) {
                console.error('Error fetching/processing Compass data via worker:', error); showMessage(`Error fetching Compass data: ${error.message}.`, 'error', 'calendar'); updateStatusIndicator('failed');
                if (isInitialLoadForThisCall) isFirstLoad = false;
            }
        }
        function parseCalendarData(icsData) {
            try {
                const jcalData = ICAL.parse(icsData); const comp = new ICAL.Component(jcalData); const vevents = comp.getAllSubcomponents('vevent'); if (!vevents || vevents.length === 0) return [];
                const today = new Date(); today.setHours(0, 0, 0, 0);
                return vevents.map(vevent => { const event = new ICAL.Event(vevent); const startDate = event.startDate.toJSDate(); return { id: event.uid || `${event.summary}-${startDate.toISOString()}`, summary: event.summary || 'No Title', originalSummary: event.summary || 'No Title', startDate: startDate, endDate: event.endDate.toJSDate(), location: event.location || null, description: event.description || '', teacher: extractTeacher(event.description || '') }; }).filter(event => event.startDate >= today);
            } catch (parseError) { console.error('Error parsing iCal data:', parseError); showMessage(`Error parsing calendar data: ${parseError.message}`, 'error', 'calendar'); return []; }
        }

        function applyMappings(originalSummary) {
            const sortedCodes = Object.keys(classMappings).sort((a, b) => b.length - a.length);
            for (const code of sortedCodes) { const escapedCode = code.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); const regex = new RegExp(escapedCode, 'i'); if (regex.test(originalSummary)) { return classMappings[code]; } }
            return originalSummary;
        }
        function getClassColor(originalSummary, mappedSummary) {
             if (originalSummary !== mappedSummary) { return classColors[mappedSummary] || '#e5e7eb';
             } else { const sortedCodes = Object.keys(classMappings).sort((a, b) => b.length - a.length); for (const code of sortedCodes) { const escapedCode = code.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); const regex = new RegExp(escapedCode, 'i'); if (regex.test(originalSummary)) { return classColors[classMappings[code]] || '#e5e7eb'; } } }
             return '#e5e7eb';
         }
        function processAndClassifyEvents(events) {
            const newProcessedClasses = []; const newProcessedSidebar = []; const prevEventMap = new Map(previousProcessedClassEvents.map(e => [e.id, e]));
            events.forEach(event => {
                const newEvent = { ...event };
                if (!newEvent.isCanvasAssignment) { newEvent.summary = applyMappings(newEvent.originalSummary); newEvent.color = getClassColor(newEvent.originalSummary, newEvent.summary); }
                const previousEvent = prevEventMap.get(newEvent.id); if (previousEvent && previousEvent.location !== newEvent.location) { newEvent.oldLocation = previousEvent.location; } else { delete newEvent.oldLocation; }
                const summaryLower = newEvent.summary.toLowerCase(); const originalSummaryLower = newEvent.originalSummary.toLowerCase();
                const containsNonClassKeyword = /\b(due|assignment|meeting|event|holiday|assembly|whole school|carnival)\b/i;
                const isLikelyClass = newEvent.location && !containsNonClassKeyword.test(summaryLower) && !containsNonClassKeyword.test(originalSummaryLower) && !newEvent.isCanvasAssignment;
                if (isLikelyClass) { newProcessedClasses.push(newEvent); } else { newProcessedSidebar.push(newEvent); }
            });
            processedClassEvents = newProcessedClasses;
            processedSidebarEvents = newProcessedSidebar.sort((a, b) => a.startDate - b.startDate);
        }


        function renderViews() { if (currentViewMode === 'list') { renderListView(); } else { renderWeeklyView(); } renderSidebar(); calendarDisplayList.classList.toggle('hidden', currentViewMode !== 'list'); calendarDisplayWeek.classList.toggle('hidden', currentViewMode !== 'week');}
        function renderListView() {
            clearDisplayAreaOnly('list');
            const combinedEvents = [...processedClassEvents, ...processedSidebarEvents.filter(e => e.isCanvasAssignment && e.startDate >= new Date())];
            const eventsToDisplay = filterAndSortEvents(combinedEvents);
            const eventsByDay = groupEventsByDay(eventsToDisplay);
            const sortedDays = Object.keys(eventsByDay).sort((a, b) => new Date(a) - new Date(b));

            if (sortedDays.length === 0 && !isFirstLoad) { if (combinedEvents.length > 0 && currentSearchTerm) { showMessage(`No items found matching "${currentSearchTerm}".`, 'info', 'calendar'); } else if (combinedEvents.length === 0 && allParsedEvents.length > 0) { showMessage('No upcoming classes or assignments.', 'info', 'calendar'); } else if (allParsedEvents.length === 0) { if (!localStorage.getItem(CALENDAR_URL_KEY)) { showMessage('Go to Settings to enter your calendar URL.', 'info', 'calendar'); } else if (!calendarMessageArea.textContent.includes('Failed')) { showMessage('No upcoming events found.', 'info', 'calendar');}} return; }

            const now = new Date();
            sortedDays.forEach((dayString, dayIndex) => {
                const dayEvents = eventsByDay[dayString]; const dayDate = new Date(dayString); const dayHeader = document.createElement('h3'); dayHeader.className = 'text-lg font-semibold text-gray-700 mt-5 mb-2 border-b pb-1'; if (!isAutoRefreshing) { dayHeader.classList.add('fade-in'); dayHeader.style.animationDelay = `${dayIndex * 0.05}s`; } dayHeader.textContent = formatDateHeading(dayDate); calendarDisplayList.appendChild(dayHeader);
                dayEvents.forEach((event, eventIndex) => {
                    const card = document.createElement('div');
                    card.className = `event-card p-3 rounded-lg border shadow-sm ${event.isCanvasAssignment ? 'canvas-assignment-event' : ''}`;
                    card.style.backgroundColor = event.color || (event.isCanvasAssignment ? '#fed7d7' : '#ffffff');
                    card.style.borderColor = darkenColor(event.color || (event.isCanvasAssignment ? '#fed7d7' : '#e5e7eb'), 15);
                    if (!isAutoRefreshing) { card.classList.add('fade-in'); card.style.animationDelay = `${(dayIndex * 50) + (eventIndex * 30) + 50}ms`; } else { card.style.opacity = '1'; card.style.transform = 'translateY(0)'; }

                    const startTime = formatTime(event.startDate); const endTime = formatTime(event.endDate);
                    const textColor = isColorDark(event.color || (event.isCanvasAssignment ? '#fed7d7' : '#ffffff')) ? 'text-white' : 'text-gray-800';
                    const iconColor = isColorDark(event.color || (event.isCanvasAssignment ? '#fed7d7' : '#ffffff')) ? 'text-gray-300' : 'text-gray-500';
                    const clockIcon = ICONS.clock.replace('text-gray-500', iconColor);
                    const locationIcon = ICONS.location.replace('text-gray-500', iconColor);
                    const teacherIcon = ICONS.teacher.replace('text-gray-500', iconColor);
                    const assignmentIcon = ICONS.assignment.replace('text-gray-500', iconColor);

                    let summaryHtml = event.summary;
                    const canvasCourseId = canvasCourseMappings[event.summary];
                    if (!event.isCanvasAssignment && canvasCourseId && canvasDomain) {
                        const canvasLink = `https://${canvasDomain}/courses/${canvasCourseId}`;
                        summaryHtml = `<a href="${canvasLink}" target="_blank" class="clickable-class-link hover:text-indigo-500">${event.summary}${ICONS.link}</a>`;
                    } else if (event.isCanvasAssignment && event.html_url) {
                        summaryHtml = `<a href="${event.html_url}" target="_blank" class="clickable-class-link hover:text-red-500">${event.summary}${ICONS.link}</a>`;
                    }

                    let timeIndicatorHtml = '';
                    if (now >= event.startDate && now <= event.endDate && !event.isCanvasAssignment) {
                        timeIndicatorHtml = `<span class="time-indicator time-indicator-now">NOW</span>`;
                    } else if (event.startDate > now && event.startDate.toDateString() === now.toDateString() && !event.isCanvasAssignment) {
                        const diffMins = Math.round((event.startDate.getTime() - now.getTime()) / 60000);
                        if (diffMins > 0 && diffMins <= 240) { // Show for up to 4 hours before
                             timeIndicatorHtml = `<span class="time-indicator time-indicator-upcoming">In ${diffMins} min${diffMins > 1 ? 's' : ''}</span>`;
                        }
                    }


                    let locationHtml = ''; if (event.oldLocation) { locationHtml += `<span class="text-red-500 line-through mr-1 opacity-80">${event.oldLocation}</span>`; } locationHtml += (event.location || 'N/A');
                    card.innerHTML = `<div class="flex flex-col sm:flex-row justify-between sm:items-start mb-1"><h4 class="text-md font-semibold ${textColor} flex-grow pr-2">${summaryHtml} ${timeIndicatorHtml}</h4><span class="text-xs font-medium ${textColor} mt-1 sm:mt-0 whitespace-nowrap">${event.isCanvasAssignment ? assignmentIcon : clockIcon} ${startTime}${event.isCanvasAssignment ? '' : ' - ' + endTime}</span></div><div class="text-xs ${textColor} space-y-1 opacity-90"><p>${locationIcon} <span class="font-medium">${event.isCanvasAssignment ? 'Course' : 'Room'}:</span> ${locationHtml}</p>${event.teacher && !event.isCanvasAssignment ? `<p>${teacherIcon} <span class="font-medium">Teacher:</span> ${event.teacher}</p>` : ''}</div>`;
                    calendarDisplayList.appendChild(card);
                });
            });
        }
        function renderWeeklyView() {
            clearDisplayAreaOnly('week'); weeklyViewGrid.innerHTML = ''; const hourStart = 8; const hourEnd = 16; const slotHeight = 60;
            for (let h = hourStart; h < hourEnd; h++) { const timeDiv = document.createElement('div'); timeDiv.className = 'time-slot'; timeDiv.textContent = formatTime(new Date(0,0,0, h, 0)); timeDiv.style.gridRow = `${h - hourStart + 1} / span 1`; weeklyViewGrid.appendChild(timeDiv); for(let dayIndex=0; dayIndex < 5; dayIndex++) { const cell = document.createElement('div'); cell.className = 'day-column-bg'; cell.style.gridRow = `${h - hourStart + 1} / span 1`; cell.style.gridColumn = `${dayIndex + 2} / span 1`; weeklyViewGrid.appendChild(cell); } }
            const dayContentContainers = []; for(let dayIndex=0; dayIndex < 5; dayIndex++) { const container = document.createElement('div'); container.className = 'day-column-content'; container.setAttribute('data-day-index', dayIndex.toString()); weeklyViewGrid.appendChild(container); dayContentContainers.push(container); }
            const today = new Date(); const currentDayOfWeek = (today.getDay() + 6) % 7; const monday = new Date(today); monday.setDate(today.getDate() - currentDayOfWeek); monday.setHours(0, 0, 0, 0); const friday = new Date(monday); friday.setDate(monday.getDate() + 4); friday.setHours(23, 59, 59, 999);

            const combinedEventsForWeek = [...processedClassEvents, ...processedSidebarEvents.filter(e => e.isCanvasAssignment && e.startDate >= new Date())]
                .filter(event => event.startDate >= monday && event.startDate <= friday);

            const nowTime = new Date().getTime();
            combinedEventsForWeek.forEach((event, eventIndex) => {
                const eventDayIndex = (event.startDate.getDay() + 6) % 7;
                if (eventDayIndex >= 0 && eventDayIndex < 5) {
                    const startHour = event.startDate.getHours(); const startMinutes = event.startDate.getMinutes(); const endHour = event.endDate.getHours(); const endMinutes = event.endDate.getMinutes();
                    const startOffsetMinutes = Math.max(0, (startHour - hourStart) * 60 + startMinutes); const topPx = (startOffsetMinutes / 60) * slotHeight;
                    const eventStartMillis = Math.max(event.startDate.getTime(), new Date(event.startDate).setHours(hourStart, 0, 0, 0)); const eventEndMillis = Math.min(event.endDate.getTime(), new Date(event.startDate).setHours(hourEnd, 0, 0, 0));
                    const durationMinutes = Math.max(15, (eventEndMillis - eventStartMillis) / (1000 * 60)); const heightPx = (durationMinutes / 60) * slotHeight;
                    if (eventEndMillis > new Date(event.startDate).setHours(hourStart, 0, 0, 0) && eventStartMillis < new Date(event.startDate).setHours(hourEnd, 0, 0, 0)) {
                        const eventDiv = document.createElement('div');
                        let isClickable = false; let linkUrl = '';
                        if (event.isCanvasAssignment && event.html_url) { isClickable = true; linkUrl = event.html_url;
                        } else if (!event.isCanvasAssignment && canvasCourseMappings[event.summary] && canvasDomain) { isClickable = true; linkUrl = `https://${canvasDomain}/courses/${canvasCourseMappings[event.summary]}`; }

                        eventDiv.className = `week-event ${event.isCanvasAssignment ? 'canvas-assignment-event' : ''} ${isClickable ? 'clickable-week-event' : ''}`;
                        eventDiv.style.top = `${topPx}px`; eventDiv.style.height = `${heightPx}px`;
                        eventDiv.style.backgroundColor = event.color || (event.isCanvasAssignment ? '#fed7d7' : '#e5e7eb');
                        eventDiv.style.borderColor = darkenColor(event.color || (event.isCanvasAssignment ? '#fed7d7' : '#e5e7eb'), 15);
                        const textColor = isColorDark(event.color || (event.isCanvasAssignment ? '#fed7d7' : '#ffffff')) ? 'text-white' : 'text-gray-800';

                        if (!isAutoRefreshing) { eventDiv.classList.add('fade-in'); eventDiv.style.animationDelay = `${eventIndex * 0.03}s`; } else { eventDiv.style.opacity = '1'; eventDiv.style.transform = 'translateY(0)'; }

                        let locationHtml = ''; if (event.oldLocation) { locationHtml += `<span class="text-red-500 line-through mr-1 opacity-80">${event.oldLocation}</span>`; } locationHtml += (event.location || '');
                        let summaryText = event.summary;
                        if(isClickable) summaryText += ` ${ICONS.link.replace('text-blue-500', textColor).replace('hover:text-blue-700', '')}`;

                        let timeIndicatorHtml = '';
                        if (nowTime >= event.startDate.getTime() && nowTime <= event.endDate.getTime() && !event.isCanvasAssignment) {
                            timeIndicatorHtml = `<span class="time-indicator time-indicator-now !text-xs !px-1 !py-0.5">NOW</span>`;
                        } else if (event.startDate.getTime() > nowTime && event.startDate.toDateString() === new Date(nowTime).toDateString() && !event.isCanvasAssignment) {
                            const diffMins = Math.round((event.startDate.getTime() - nowTime) / 60000);
                            if (diffMins > 0 && diffMins <= 240) {
                                 timeIndicatorHtml = `<span class="time-indicator time-indicator-upcoming !text-xs !px-1 !py-0.5">In ${diffMins}m</span>`;
                            }
                        }

                        eventDiv.innerHTML = `<strong class="${textColor}">${summaryText} ${timeIndicatorHtml}</strong><br><span class="text-xs ${textColor} opacity-80">${locationHtml}</span>`;
                        eventDiv.title = `${event.summary}\n${formatTime(event.startDate)} - ${formatTime(event.endDate)}\nRoom: ${event.location || 'N/A'}${event.teacher ? '\nTeacher: ' + event.teacher : ''}`;
                        if (isClickable) { eventDiv.onclick = () => window.open(linkUrl, '_blank'); }
                        const targetContainer = dayContentContainers[eventDayIndex]; if (targetContainer) { targetContainer.appendChild(eventDiv); }
                    }
                }
            });
        }
        function renderSidebar() {
            sidebarEventsDiv.innerHTML = '';
            const relevantSidebarEvents = processedSidebarEvents.filter(e => e.startDate >= new Date());
            if (relevantSidebarEvents.length === 0) { sidebarEventsDiv.innerHTML = '<p class="text-sm text-gray-500 italic">No other events or due dates found.</p>'; sidebar.classList.add('hidden'); return; }
            sidebar.classList.remove('hidden');
            relevantSidebarEvents.forEach((event, index) => {
                const card = document.createElement('div');
                card.className = `sidebar-event-card p-2.5 rounded-md border shadow-sm ${event.isCanvasAssignment ? 'canvas-assignment' : ''}`;
                if (!isAutoRefreshing) { card.classList.add('fade-in'); card.style.animationDelay = `${index * 0.04}s`; } else { card.style.opacity = '1'; card.style.transform = 'translateY(0)'; }
                const startTime = formatTime(event.startDate); const startDateStr = event.startDate.toLocaleDateString([], { weekday: 'short', month: 'short', day: 'numeric' });
                const isAssignmentIcon = event.isCanvasAssignment || /\b(due|assignment)\b/i.test(event.summary) || /\b(due|assignment)\b/i.test(event.originalSummary);
                const icon = isAssignmentIcon ? ICONS.assignment : ICONS.event;
                let summaryHtml = event.summary;
                if (event.isCanvasAssignment && event.html_url) {
                    summaryHtml = `<a href="${event.html_url}" target="_blank" class="hover:underline">${event.summary}${ICONS.link}</a>`;
                }
                card.innerHTML = `<h4 class="text-sm font-semibold text-gray-800 mb-1">${summaryHtml}</h4><p class="text-xs text-gray-600">${icon} ${startDateStr} ${event.startDate.getHours() !== 0 || event.startDate.getMinutes() !== 0 ? 'at ' + startTime : ''}</p>${event.location ? `<p class="text-xs text-gray-600">${ICONS.location} ${event.location}</p>` : ''}`;
                sidebarEventsDiv.appendChild(card);
            });
        }

        async function fetchCanvasAPI(canvasApiEndpointWithPathAndQuery) {
            if (!compassWorkerUrl) { showMessageForCanvas('Cloudflare Worker URL not set in Settings.', 'error'); return null; }
            if (!canvasDomain || !canvasToken) { showMessageForCanvas('Canvas Domain and API Token not set in Settings.', 'error'); return null; }
            const workerPath = `${compassWorkerUrl}/canvas/${canvasApiEndpointWithPathAndQuery}`;
            const finalWorkerUrl = new URL(workerPath);
            finalWorkerUrl.searchParams.append('domain', canvasDomain);
            try {
                const response = await fetch(finalWorkerUrl.toString(), { headers: { 'Authorization': `Bearer ${canvasToken}` } });
                if (!response.ok) { const errorData = await response.json().catch(() => ({ error: `Worker error: ${response.status} ${response.statusText}` })); throw new Error(errorData.error || `Failed to fetch from Canvas via worker: ${response.status}`); }
                return await response.json();
            } catch (error) { console.error('Canvas API Fetch Error via Worker:', error); showMessageForCanvas(`Error fetching from Canvas: ${error.message}. Check worker logs if issue persists.`, 'error'); return null; }
        }
        async function fetchCanvasCourses() { const courses = await fetchCanvasAPI('api/v1/courses?enrollment_state=active&per_page=50'); if (courses) { fetchedCanvasCourses = courses.map(course => ({ id: course.id, name: course.name, course_code: course.course_code })); return fetchedCanvasCourses; } return []; }
        async function fetchAssignmentsForCourse(courseId) { const assignments = await fetchCanvasAPI(`api/v1/courses/${courseId}/assignments?order_by=due_at&bucket=upcoming&per_page=50`); return assignments || []; }

        async function processCanvasAssignmentsIntoEvents() {
            if (!compassWorkerUrl || !canvasDomain || !canvasToken) return;
            const courses = await fetchCanvasCourses();
            if (!courses || courses.length === 0) return;
            let newCanvasAssignmentEvents = [];
            for (const course of courses) {
                const assignments = await fetchAssignmentsForCourse(course.id);
                if (assignments && assignments.length > 0) {
                    assignments.forEach(assignment => {
                        if (assignment.due_at) {
                            const dueDate = new Date(assignment.due_at);
                            newCanvasAssignmentEvents.push({
                                id: `canvas-asgn-${assignment.id}`,
                                summary: `(Canvas) ${assignment.name}`,
                                originalSummary: `(Canvas) ${assignment.name} - ${course.name}`,
                                startDate: dueDate,
                                endDate: new Date(dueDate.getTime() + 30 * 60000),
                                location: `Canvas: ${course.name}`,
                                description: assignment.html_url,
                                isCanvasAssignment: true,
                                html_url: assignment.html_url,
                                color: '#FFCDD2'
                            });
                        }
                    });
                }
            }
            allParsedEvents = allParsedEvents.filter(event => !event.isCanvasAssignment);
            allParsedEvents.push(...newCanvasAssignmentEvents);
        }

        async function fetchCanvasData() {
            if (!compassWorkerUrl || !canvasDomain || !canvasToken) { showMessageForCanvas('Please set Worker URL, Canvas Domain and API Token in Settings.', 'info'); return; }
            showMessageForCanvas('Loading Canvas data for Canvas Tab...', 'loading');
            const courses = fetchedCanvasCourses.length > 0 ? fetchedCanvasCourses : await fetchCanvasCourses();
            if (!courses || courses.length === 0) { if (!canvasDataMessageArea.textContent.includes('Error')) { showMessageForCanvas('No active Canvas courses found or failed to load courses.', 'info');} return; }
            canvasCoursesDisplay.innerHTML = ''; let assignmentsFound = 0;
            for (const course of courses) {
                const courseDiv = document.createElement('div'); courseDiv.className = 'canvas-item-card p-4 rounded-lg shadow mb-4';
                courseDiv.innerHTML = `<h3 class="text-lg font-semibold text-indigo-700 mb-2">${course.name} <span class="text-sm text-gray-500">(${course.course_code || 'ID: ' + course.id})</span></h3>`;
                const assignmentsList = document.createElement('ul'); assignmentsList.className = 'list-disc list-inside space-y-1 pl-2 text-sm';
                const assignments = await fetchAssignmentsForCourse(course.id);
                if (assignments && assignments.length > 0) {
                    assignmentsFound += assignments.length;
                    assignments.forEach(assignment => { const li = document.createElement('li'); const dueDate = assignment.due_at ? new Date(assignment.due_at).toLocaleDateString([], { month: 'short', day: 'numeric', hour:'numeric', minute:'2-digit' }) : 'No due date'; li.innerHTML = `<a href="${assignment.html_url}" target="_blank" class="text-blue-600 hover:underline">${assignment.name}${ICONS.link}</a> - Due: ${dueDate}`; assignmentsList.appendChild(li); });
                } else { assignmentsList.innerHTML = '<li class="text-gray-500 italic">No upcoming assignments.</li>'; }
                courseDiv.appendChild(assignmentsList); canvasCoursesDisplay.appendChild(courseDiv);
            }
            if (assignmentsFound > 0) { showMessageForCanvas(`Loaded ${courses.length} courses and ${assignmentsFound} upcoming assignments.`, 'success');
            } else if (courses.length > 0) { showMessageForCanvas(`Loaded ${courses.length} courses. No upcoming assignments found for these courses.`, 'info'); }
        }
        function showMessageForCanvas(msg, type = 'info') {
            canvasDataMessageArea.innerHTML = ''; const msgElement = document.createElement('div'); let bgColor, textColor, borderColor, loader = ''; let autoDismiss = (type === 'success' || type === 'info');
            switch (type) { case 'error': bgColor = 'bg-red-100'; textColor = 'text-red-700'; borderColor = 'border-red-500'; break; case 'success': bgColor = 'bg-green-100'; textColor = 'text-green-700'; borderColor = 'border-green-500'; break; case 'loading': bgColor = 'bg-blue-100'; textColor = 'text-blue-700'; borderColor = 'border-blue-500'; loader = '<div class="loader !w-5 !h-5 !border-2 !inline-block !mr-2 !align-middle"></div>'; break; default: bgColor = 'bg-blue-100'; textColor = 'text-blue-700'; borderColor = 'border-blue-500';}
            msgElement.className = `p-3 ${bgColor} border-l-4 ${borderColor} ${textColor} rounded-md shadow-sm text-sm fade-in`; msgElement.innerHTML = loader + msg; canvasDataMessageArea.appendChild(msgElement);
            if (autoDismiss) { setTimeout(() => { if (canvasDataMessageArea.contains(msgElement)) { msgElement.classList.remove('fade-in'); msgElement.classList.add('fade-out'); msgElement.addEventListener('animationend', () => { if(canvasDataMessageArea.contains(msgElement)) canvasDataMessageArea.removeChild(msgElement); }, { once: true }); } }, 3000); }
        }

        // --- Notification Functions ---
        function renderNotificationSettings() {
            notifyClassesEnabledCheckbox.checked = notificationSettings.classesEnabled;
            notifyClassesLeadTimeInput.value = notificationSettings.classesLeadTime;
            notifyAssignmentsEnabled1Checkbox.checked = notificationSettings.assignmentsEnabled1;
            notifyAssignmentsLeadTime1Input.value = notificationSettings.assignmentsLeadTime1;
            notifyAssignmentsEnabled2Checkbox.checked = notificationSettings.assignmentsEnabled2;
            notifyAssignmentsLeadTime2Input.value = notificationSettings.assignmentsLeadTime2;
            notifyTimetableChangesEnabledCheckbox.checked = notificationSettings.timetableChangesEnabled; // New
            updateNotificationPermissionStatus();
        }

        function handleSaveNotificationSettings() {
            notificationSettings.classesEnabled = notifyClassesEnabledCheckbox.checked;
            notificationSettings.classesLeadTime = parseInt(notifyClassesLeadTimeInput.value) || 5;
            notificationSettings.assignmentsEnabled1 = notifyAssignmentsEnabled1Checkbox.checked;
            notificationSettings.assignmentsLeadTime1 = parseInt(notifyAssignmentsLeadTime1Input.value) || 60;
            notificationSettings.assignmentsEnabled2 = notifyAssignmentsEnabled2Checkbox.checked;
            notificationSettings.assignmentsLeadTime2 = parseInt(notifyAssignmentsLeadTime2Input.value) || 5;
            notificationSettings.timetableChangesEnabled = notifyTimetableChangesEnabledCheckbox.checked; // New
            saveSettings(true, 'notifications');
        }

        function setupNotificationPermission() {
            if (!("Notification" in window)) {
                notificationPermissionStatusDiv.textContent = "This browser does not support desktop notification.";
                return;
            }
            updateNotificationPermissionStatus();
            [notifyClassesEnabledCheckbox, notifyAssignmentsEnabled1Checkbox, notifyAssignmentsEnabled2Checkbox, notifyTimetableChangesEnabledCheckbox].forEach(cb => {
                cb.addEventListener('change', () => {
                    if (cb.checked && Notification.permission === 'default') {
                        requestNotificationPermission();
                    }
                });
            });
        }

        function requestNotificationPermission() {
            Notification.requestPermission().then(permission => {
                notificationPermission = permission;
                updateNotificationPermissionStatus();
                if (permission === 'granted') {
                    new Notification("Class Companion", { body: "Notifications enabled!" });
                }
            });
        }

        function updateNotificationPermissionStatus() {
            if (Notification.permission === "granted") {
                notificationPermissionStatusDiv.textContent = "Notifications are enabled.";
                notificationPermissionStatusDiv.className = "text-sm text-green-600 mb-3";
            } else if (Notification.permission === "denied") {
                notificationPermissionStatusDiv.textContent = "Notifications are disabled by browser. Please enable them in your browser settings.";
                notificationPermissionStatusDiv.className = "text-sm text-red-600 mb-3";
            } else {
                notificationPermissionStatusDiv.textContent = "Click 'Save Notification Preferences' after enabling to request permission.";
                notificationPermissionStatusDiv.className = "text-sm text-gray-600 mb-3";
            }
        }

        function sendBrowserNotification(title, body, tag = null) {
            if (notificationPermission !== 'granted') return;
            const options = { body: body, icon: './favicon.ico' }; // Replace with your actual icon if you have one
            if (tag) options.tag = tag; // Tag helps replace existing notifications with the same tag
            new Notification(title, options);
        }


        function detectAndNotifyTimetableChanges(newEvents, oldEvents) {
            if (!notificationSettings.timetableChangesEnabled || notificationPermission !== 'granted') return;

            const oldEventsMap = new Map(oldEvents.map(e => [e.id, e]));
            const newEventsMap = new Map(newEvents.map(e => [e.id, e]));

            // Check for changed or cancelled events
            oldEvents.forEach(oldEvent => {
                if (oldEvent.isCanvasAssignment) return; // Only for Compass classes

                const newEvent = newEventsMap.get(oldEvent.id);
                const notificationIdBase = `tt_change_${oldEvent.id}`;

                if (!newEvent) { // Event cancelled
                    const notificationId = `${notificationIdBase}_cancelled`;
                    if (!sentNotifications.has(notificationId)) {
                        sendBrowserNotification(
                            "Class Cancelled",
                            `${oldEvent.summary} at ${formatTime(oldEvent.startDate)} has been cancelled.`,
                            notificationId
                        );
                        sentNotifications.add(notificationId);
                    }
                } else {
                    // Room Change
                    if (oldEvent.location !== newEvent.location) {
                        const notificationId = `${notificationIdBase}_room_${newEvent.location}`;
                         if (!sentNotifications.has(notificationId)) {
                            sendBrowserNotification(
                                "Room Change",
                                `${newEvent.summary} at ${formatTime(newEvent.startDate)} is now in ${newEvent.location || 'N/A'} (was ${oldEvent.location || 'N/A'}).`,
                                notificationId
                            );
                            sentNotifications.add(notificationId);
                        }
                    }
                    // Time Change (start or end)
                    if (oldEvent.startDate.getTime() !== newEvent.startDate.getTime() || oldEvent.endDate.getTime() !== newEvent.endDate.getTime()) {
                        const notificationId = `${notificationIdBase}_time_${newEvent.startDate.getTime()}`;
                        if (!sentNotifications.has(notificationId)) {
                            sendBrowserNotification(
                                "Class Time Change",
                                `${newEvent.summary} is now at ${formatTime(newEvent.startDate)} - ${formatTime(newEvent.endDate)} (was ${formatTime(oldEvent.startDate)} - ${formatTime(oldEvent.endDate)}).`,
                                notificationId
                            );
                            sentNotifications.add(notificationId);
                        }
                    }
                }
            });
             // Optional: Check for newly added classes (not implemented here to avoid too many notifications)
        }


        function checkAndSendNotifications() {
            if (notificationPermission !== 'granted') return;

            const now = new Date().getTime();
            const upcomingEvents = [...processedClassEvents, ...processedSidebarEvents.filter(e => e.isCanvasAssignment)];

            upcomingEvents.forEach(event => {
                const eventTime = event.startDate.getTime();
                const eventIdBase = event.id;

                // Class notifications
                if (notificationSettings.classesEnabled && !event.isCanvasAssignment) {
                    const notifyTime = eventTime - (notificationSettings.classesLeadTime * 60000);
                    const notificationId = `${eventIdBase}_class_${notificationSettings.classesLeadTime}`;
                    if (now >= notifyTime && now < eventTime && !sentNotifications.has(notificationId)) {
                        sendBrowserNotification(
                            "Class Starting Soon!",
                            `${event.summary} at ${formatTime(event.startDate)}${event.location ? ' in ' + event.location : ''}`,
                            notificationId
                        );
                        sentNotifications.add(notificationId);
                    }
                }

                // Assignment notifications
                if (event.isCanvasAssignment) {
                    if (notificationSettings.assignmentsEnabled1) {
                        const notifyTime1 = eventTime - (notificationSettings.assignmentsLeadTime1 * 60000);
                        const notificationId1 = `${eventIdBase}_assign1_${notificationSettings.assignmentsLeadTime1}`;
                        if (now >= notifyTime1 && now < eventTime && !sentNotifications.has(notificationId1)) {
                            sendBrowserNotification(
                                "Assignment Due Soon!",
                                `${event.summary} is due at ${formatTime(event.startDate)} (${notificationSettings.assignmentsLeadTime1} mins).`,
                                notificationId1
                            );
                            sentNotifications.add(notificationId1);
                        }
                    }
                    if (notificationSettings.assignmentsEnabled2) {
                        const notifyTime2 = eventTime - (notificationSettings.assignmentsLeadTime2 * 60000);
                        const notificationId2 = `${eventIdBase}_assign2_${notificationSettings.assignmentsLeadTime2}`;
                        if (now >= notifyTime2 && now < eventTime && !sentNotifications.has(notificationId2)) {
                           sendBrowserNotification(
                                "Assignment Due Very Soon!",
                                `${event.summary} is due at ${formatTime(event.startDate)} (${notificationSettings.assignmentsLeadTime2} mins!).`,
                                notificationId2
                            );
                            sentNotifications.add(notificationId2);
                        }
                    }
                }
            });
        }

        function startNotificationChecker() {
            if (notificationCheckIntervalId) clearInterval(notificationCheckIntervalId);
            notificationCheckIntervalId = setInterval(checkAndSendNotifications, NOTIFICATION_CHECK_INTERVAL);
        }


        function handleSearch(event) { currentSearchTerm = event.target.value.toLowerCase(); renderListView(); }
        function handleSort(event) { currentSortOrder = event.target.value; renderListView(); }
        function filterAndSortEvents(events) { const filtered = events.filter(event => { if (!currentSearchTerm) return true; const teacherMatch = event.teacher ? event.teacher.toLowerCase().includes(currentSearchTerm) : false; return ( event.summary.toLowerCase().includes(currentSearchTerm) || event.originalSummary.toLowerCase().includes(currentSearchTerm) || (event.location && event.location.toLowerCase().includes(currentSearchTerm)) || teacherMatch ); }); return filtered; }
        function groupEventsByDay(events) { const grouped = {}; events.forEach(event => { const dayKey = event.startDate.toDateString(); if (!grouped[dayKey]) grouped[dayKey] = []; grouped[dayKey].push(event); }); for (const dayKey in grouped) { grouped[dayKey].sort((a, b) => { switch (currentSortOrder) { case 'name': return a.summary.localeCompare(b.summary); case 'location': return (a.location || '').localeCompare(b.location || ''); case 'time': default: return a.startDate - b.startDate; } }); } return grouped; }

        function initializeStatusIndicator() { if (statusUpdateIntervalId) clearInterval(statusUpdateIntervalId); statusUpdateIntervalId = setInterval(updateAgoText, STATUS_UPDATE_INTERVAL); updateStatusIndicator(currentStatus); }
        function updateStatusIndicator(status) { currentStatus = status; statusIndicatorDiv.classList.remove('hidden'); let iconHtml = ''; let textPrefix = ''; let textClass = 'status-text'; let iconClass = 'status-icon'; switch (status) { case 'live': iconHtml = ''; iconClass += ' live'; textPrefix = 'LIVE'; break; case 'failed': iconHtml = ICONS.cloudError; iconClass += ' failed'; textClass += ' failed'; textPrefix = 'FAILED'; break; case 'loading': iconHtml = '<div class="loader !w-3 !h-3 !border-2 !border-t-blue-500 !m-0"></div>'; iconClass = ''; textPrefix = 'Loading...'; break; case 'idle': default: statusIndicatorDiv.classList.add('hidden'); return; } statusIconSpan.innerHTML = iconHtml; statusIconSpan.className = iconClass; statusTextSpan.className = textClass; statusTextSpan.textContent = `${textPrefix} - ${getAgoText()}`; }
        function updateAgoText() { if (currentStatus === 'live' || currentStatus === 'failed') { statusTextSpan.textContent = `${currentStatus.toUpperCase()} - ${getAgoText()}`; } else if (currentStatus === 'loading') { statusTextSpan.textContent = 'Loading...'; } }
        function getAgoText() { if (!lastSuccessfulUpdateTime) return 'never updated'; const now = Date.now(); const secondsAgo = Math.round((now - lastSuccessfulUpdateTime) / 1000); if (secondsAgo < 5) return 'updated just now'; if (secondsAgo < 60) return `updated ${secondsAgo}s ago`; const minutesAgo = Math.floor(secondsAgo / 60); if (minutesAgo < 60) return `updated ${minutesAgo}m ago`; const hoursAgo = Math.floor(minutesAgo / 60); return `updated ${hoursAgo}h ago`; }

        function clearDisplay() { calendarDisplayList.innerHTML = ''; weeklyViewGrid.innerHTML = ''; sidebarEventsDiv.innerHTML = ''; canvasCoursesDisplay.innerHTML = ''; canvasDataMessageArea.innerHTML = '';}
        function clearDisplayAreaOnly(view = 'list') { if (view === 'list') calendarDisplayList.innerHTML = ''; else if (view === 'week') weeklyViewGrid.innerHTML = ''; else if (view === 'canvas') canvasCoursesDisplay.innerHTML = '';}
        function showMessage(msg, type = 'info', location = 'calendar') { const targetMessageArea = location === 'settings' ? settingsMessageArea : calendarMessageArea; if (messageTimeout && targetMessageArea.contains(messageTimeout.element)) { clearTimeout(messageTimeout.id); if (messageTimeout.element && targetMessageArea.contains(messageTimeout.element)) {targetMessageArea.removeChild(messageTimeout.element);} } targetMessageArea.innerHTML = ''; const msgElement = document.createElement('div'); let bgColor, textColor, borderColor, loader = ''; let autoDismiss = false; switch (type) { case 'error': bgColor = 'bg-red-100'; textColor = 'text-red-700'; borderColor = 'border-red-500'; break; case 'success': bgColor = 'bg-green-100'; textColor = 'text-green-700'; borderColor = 'border-green-500'; autoDismiss = true; break; case 'loading': bgColor = 'bg-blue-100'; textColor = 'text-blue-700'; borderColor = 'border-blue-500'; loader = '<div class="loader !w-5 !h-5 !border-2 !inline-block !mr-2 !align-middle"></div>'; break; default: bgColor = 'bg-blue-100'; textColor = 'text-blue-700'; borderColor = 'border-blue-500'; autoDismiss = true;} msgElement.className = `p-3 ${bgColor} border-l-4 ${borderColor} ${textColor} rounded-md shadow-sm text-sm fade-in`; msgElement.innerHTML = loader + msg; targetMessageArea.appendChild(msgElement); if (autoDismiss) { const timeoutId = setTimeout(() => { if (targetMessageArea.contains(msgElement)) { msgElement.classList.remove('fade-in'); msgElement.classList.add('fade-out'); msgElement.addEventListener('animationend', () => { if(targetMessageArea.contains(msgElement)) {targetMessageArea.removeChild(msgElement);} }, { once: true }); } if (messageTimeout && messageTimeout.id === timeoutId) { messageTimeout = null; } }, 3000); messageTimeout = { id: timeoutId, element: msgElement }; } else { messageTimeout = { id: null, element: msgElement }; } }
        function formatTime(date) { return date.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit', hour12: true }); }
        function formatDateHeading(date) { const options = { weekday: 'long', month: 'long', day: 'numeric' }; return date.toLocaleDateString(undefined, options); }
        function extractTeacher(description) { const lines = description.split('\\n'); let teacherLine = lines.find(line => /^\s*teacher:/i.test(line)); if (teacherLine) return teacherLine.replace(/^\s*teacher:/i, '').trim(); return null; }
        function isColorDark(hexColor) { if (!hexColor || hexColor.length < 4) return false; hexColor = hexColor.substring(1); if (hexColor.length === 3) hexColor = hexColor.split('').map(c => c + c).join(''); const r = parseInt(hexColor.substring(0, 2), 16); const g = parseInt(hexColor.substring(2, 4), 16); const b = parseInt(hexColor.substring(4, 6), 16); const hsp = Math.sqrt(0.299 * (r * r) + 0.587 * (g * g) + 0.114 * (b * b)); return hsp < 127.5; }
        function darkenColor(hexColor, percent) { if (!hexColor || hexColor.length < 4) return '#cccccc'; let R = parseInt(hexColor.substring(1,3),16); let G = parseInt(hexColor.substring(3,5),16); let B = parseInt(hexColor.substring(5,7),16); R = parseInt(R * (100 - percent) / 100); G = parseInt(G * (100 - percent) / 100); B = parseInt(B * (100 - percent) / 100); R = (R<0)?0:R; G = (G<0)?0:G; B = (B<0)?0:B; const RR = ((R.toString(16).length==1)?"0"+R.toString(16):R.toString(16)); const GG = ((G.toString(16).length==1)?"0"+G.toString(16):G.toString(16)); const BB = ((B.toString(16).length==1)?"0"+B.toString(16):B.toString(16)); return "#"+RR+GG+BB; }

    </script>
</body>
</html>

